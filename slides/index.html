<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>How to MicroPython</title>

        <link rel="stylesheet" href="css/reveal.css">
        <!-- <link rel="stylesheet" href="css/theme/black.css"> -->
        <link rel="stylesheet" href="css/theme/night.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!-- QR Codes -->
        <script type="text/javascript" src="qrcodejs/qrcode.js"></script>

        <!-- WaveDrom: Timing Diagrams-->
        <script src="http://wavedrom.com/skins/default.js" type="text/javascript"></script>
        <script src="http://wavedrom.com/wavedrom.min.js" type="text/javascript"></script>

        <!-- Manual style tweaks -->
        <style>
            /* Columns */
            /* ref: https://stackoverflow.com/questions/30861845/how-to-use-two-column-layout-with-reveal-js#answer-44392145 */
            .columns {
                display: flex;
            }
            .col {
                flex: 1;
            }

            /* Colours */
            .text-red {
                color: #f00;
            }
            .text-green {
                color: #0f0;
            }
            .text-yellow {
                color: #ff0;
            }
            .text-blue {
                color: #00f;
            }

            /* External Link */
            .prj-link {
                font-family: monospace !important;
                font-size: 0.7em !important;
            }

            .prj-link::before {
                display: inline-block;
                width: 1em;
                height: 1em;
                margin-right: 0.1em;
                margin-left: 0.1em;
                content: "";
                background: url("images/micro-sd-card.png") no-repeat 0 0;
                background-size: 100%;
                vertical-align: middle;
            }

            /* QR Code */
            .qrcode {
                background-color: #fff;
                padding: 1px 1px 1px 1px;
                display: inline-block;
            }

            .half-size {
                font-size: 0.5em !important;
            }

            /* Timing Diagram */
            .timing-diagram {
                display: inline-block;
                width: 100%;
            }

            .timing-diagram div svg {
                width: 100%;
                height: auto;
                filter: invert(100%);
            }

        </style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <!-- =================== INTRODUCTION =================== -->
                <section>
                    <section>
                        <h2>MicroPython</h2>
                        <h3>Python for micro-controllers.</h3>
                        <div class="stretch">
                            <img class="plain" src="images/logo/micropython.svg" />
                        </div>

                        <!-- Side notes shown when pressing 's' -->
                        <aside data-markdown class="notes">
                            # Remember to bring
                            - laptop + power supply
                            - pyboard
                            - USB cable (micro usb)
                            - micro SD card (pre-loaded with [pyboard-sd](https://github.com/fragmuffin/howto-micropython/tree/master/pyboard-sd))
                            - potentiometer (with connectors to pyboard)

                            TODO: finish things list
                            - Touch LCD
                            - LCD connections

                            # Hotkeys

                            - `[space]` navigates through each slide
                            - `[esc]` zoom out
                            - `[Alt+Click]` zoom to element

                        </aside>
                    </section>

                    <section>
                        <h2>Contents</h2>
                        <div class="columns">
                            <div class="col">
                                Follow along...
                                <div class="qrcode" align="center"></div>
                                <div class="half-size">
                                    <a class="qrcode-link"></a><br/>
                                    also: <a href="https://github.com/fragmuffin/howto-micropython">the github repo'</a>
                                </div>
                            </div>
                            <div class="col">
                                <ul style="font-size:0.9em">
                                    <li><a href="#/what_is_micropython">What is MicroPython?</a></li>
                                    <li><a href="#/hardware">Hardware</a></li>
                                    <li><a href="#/getting_started">Getting Started</a></li>
                                    <ul>
                                        <li><a href="#/file_system">File System</a></li>
                                        <li><a href="#/outputs">Outputs</a></li>
                                        <li><a href="#/inputs">Inputs</a></li>
                                        <li><a href="#/comms">Comms</a></li>
                                        <li><a href="#/interrupts">Interrupts</a></li>
                                    </ul>
                                    <li><a href="#/your_script">Your Script</a></li>
                                    <li><a href="#/debugging">Debugging</a></li>
                                    <li><a href="#/lcd_interface">LCD Interface</a></li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </section>

                <!-- =================== WHAT IS MICROPYTHON =================== -->
                <section id="what_is_micropython">
                    <section data-background="#28306a">
                        <h1 style="font-size: 3.5em">What is MicroPython?</h1>
                    </section>

                    <section>
                        <h3><a href="https://micropython.org/"><img class="plain" src="images/logo/micropython.png" style="vertical-align: middle; margin-right:0.2em" />micropython.org</a></h3>
                        <blockquote>
                            &ldquo;MicroPython is a lean and efficient implementation of the Python 3
                            programming language that includes a small subset of the Python standard
                            library and is optimised to run on microcontrollers and in constrained
                            environments.&rdquo;
                        </blockquote>
                    </section>
                </section>


                <!-- =================== HARDWARE =================== -->
                <section id="hardware">
                    <section data-background="#28306a">
                        <h1>Hardware</h1>
                    </section>

                    <section>
                        <div class="columns">
                            <div class="col">
                                <h3>pyboard</h3>
                                <img class="plain" src="images/pyboard/v1.1_diag.png" />
                            </div>
                            <div class="col">
                                <h3>WiPy</h3>
                                <img class="plain" src="images/wipy/side.png" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Peripherals</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th></th>
                                    <th><a href="https://www.adafruit.com/product/2390">pyboard</a></th>
                                    <th><a href="https://pycom.io/product/wipy/">WiPy</a></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>SD card socket</td>
                                    <td>Yes</td>
                                    <td>No*</td>
                                </tr>
                                <tr>
                                    <td>USB socket</td>
                                    <td>Yes</td>
                                    <td>No*</td>
                                </tr>
                                <tr>
                                    <td>WiFi built-in</td>
                                    <td>No</td>
                                    <td>Yes</td>
                                </tr>
                                <tr>
                                    <td>Accelerometer</td>
                                    <td>Yes</td>
                                    <td>No</td>
                                </tr>
                                <tr>
                                    <td>Processor Power</td>
                                    <td>Less</td>
                                    <td>More</td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="font-size:0.7em">
                            * - available via <a href="https://pycom.io/product/expansion-board-2-0/">expansion board</a>
                        </div>
                    </section>

                    <section>
                        <h2>Micro-Controller</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th></th>
                                    <th><a href="https://www.adafruit.com/product/2390">pyboard</a></th>
                                    <th><a href="https://pycom.io/product/wipy/">WiPy</a></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Model</td>
                                    <td><a href="http://www.st.com/en/microcontrollers/stm32f405rg.html">STM32F405RG</a></td>
                                    <td><a href="http://espressif.com/sites/default/files/documentation/esp32_datasheet_en.pdf">ESP32</a></td>
                                </tr>
                                <tr>
                                    <td>ROM</td>
                                    <td>1MB</td>
                                    <td>4MB</td>
                                </tr>
                                <tr>
                                    <td>RAM</td>
                                    <td>192kB</td>
                                    <td>512kB</td>
                                </tr>
                                <tr>
                                    <td>Cores</td>
                                    <td>1</td>
                                    <td>2*</td>
                                </tr>
                            </tbody>
                        </table>
                        <ul>
                            <li>1 core dedicated to networking</li>
                        </ul>
                    </section>

                    <section>
                        <h2>This Presentation</h2>
                        <div class="fragment_ fade-in">
                            <div class="columns">
                                <div class="col">
                                    <p>
                                        For the rest of this presentation I'll be
                                        using the <code>pyboard</code> v1.1.
                                    </p>
                                    <p>
                                        Note: there's more than just the pyboard
                                        and WiPy out there. Anything with
                                        a processor <a href="https://micropython.org/download">listed here</a>
                                    </p>
                                </div>
                                <div class="col">
                                    <h3>pyboard v1.1</h3>
                                    <img class="plain" width="70%" src="images/pyboard/v1.0_top.png" />
                                </div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <a href="images/pyboard/v1.1_pinout.jpg">
                            <img class="plain" src="images/pyboard/v1.1_pinout.jpg" />
                        </a>
                    </section>

                </section>

                <!-- =================== GETTING STARTED =================== -->
                <section id="getting_started">
                    <section data-background="#28306a">
                        <h1>Getting Started</h1>
                    </section>

                    <section>
                        <iframe width="1024" height="576" src="https://www.youtube.com/embed/5LbgyDmRu9s?rel=0" frameborder="0" allowfullscreen></iframe>

                        <aside data-markdown class="notes">
                            **Video Length:** 9:40

                            ## Key Moments

                            * [0:39](https://youtu.be/5LbgyDmRu9s?t=0m54s) - pyboard specs
                            * [0:54](https://youtu.be/5LbgyDmRu9s?t=0m54s) - REPL
                            * [2:15](https://youtu.be/5LbgyDmRu9s?t=2m15s) - file system
                            * [3:00](https://youtu.be/5LbgyDmRu9s?t=3m00s) - LEDs and Switch
                            * [3:32](https://youtu.be/5LbgyDmRu9s?t=3m32s) - running script from host
                            * [6:32](https://youtu.be/5LbgyDmRu9s?t=6m32s) - copy script to flash
                            * [7:32](https://youtu.be/5LbgyDmRu9s?t=7m32s) - copy script to SD
                            * [8:43](https://youtu.be/5LbgyDmRu9s?t=8m43s) - running from batt
                        </aside>
                    </section>

                    <section>
                        <h2>Powering Up</h2>
                        <ul>
                            <li><b>USB</b> - also provides serial</li>
                            <li><b>Power Supply</b> - 3.5 to 10V</li>
                            <li><b>Battery</b> - 3.5 to 10V</li>
                        </ul>
                    </section>

                    <section id="connect_to_repl">
                        <h2>Connect to REPL</h2>
                        <p>
                            Read Evaluate Print Loop (REPL)
                        </p>
                        <pre><code class="hljs" data-trim contenteditable>
                            $ cu -l /dev/ttyACM0
                            Connected.
                            MicroPython v1.9.2 on 2017-08-23; PYBv1.1 with STM32F405RG
                            Type "help()" for more information.
                            >>> import os
                            >>> os.uname().version
                            'v1.9.2 on 2017-08-23'
                        </code></pre>
                        <p>
                            for more detail: <a href="https://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/repl.html">REPL tutorial</a>
                        </p>
                    </section>

                </section>

                <!-- =================== FILE SYSTEM =================== -->
                <section id="file_system">
                    <section data-background="#28306a">
                        <h1>File System</h1>
                    </section>

                    <section>
                        <h2>Out of the Box</h2>
                        The pyboard's flash contains the following
                        <pre><code class="hljs" data-trim contenteditable>
                            flash/
                                README.txt
                                boot.py
                                main.py
                                pybcdc.inf
                            sd/
                                (sd card content)
                        </code></pre>
                        copy: <a href="https://github.com/fragmuffin/howto-micropython/tree/master/pyboard-flash" class="prj-link">/flash</a>
                    </section>

                    <section>
                        <h2>Browse with Python</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            >>> import os
                            >>> os.listdir('/')
                            ['flash', 'sd']
                            >>> os.getcwd()
                            '/flash'
                            >>> os.listdir('.')
                            ['main.py', 'pybcdc.inf', 'README.txt', 'boot.py']
                        </code></pre>
                    </section>

                    <section>
                        <h2>Hot mount SD Card</h2>
                        The SD card can be mounted after boot.
                        <pre><code class="hljs" data-trim contenteditable>
                            >>> import os, pyb
                            >>> os.umount('/sd')
                            >>> os.listdir('/')
                            ['flash']
                            >>> os.mount(pyb.SD, '/sd')
                            >>> os.listdir('/')
                            ['flash', 'sd']
                        </code></pre>
                    </section>

                    <section>
                        <h2>Hot mount SD Card</h2>
                        Raises <code>OSError</code> on failure...
                        <pre><code class="hljs" data-trim contenteditable>
                            import os, pyb
                            try:
                                os.mount(pyb.SD, '/sd')
                                print("Successfully mounted SD card")
                            except OSError:
                                print("Failed to mount SD card")
                        </code></pre>
                    </section>

                </section>

                <!-- =================== OUTPUTS =================== -->
                <section id="outputs">
                    <section data-background="#28306a">
                        <h1>Outputs</h1>
                    </section>

                    <section>
                        <h2>pyboard's LEDs</h2>
                        The pyboard has 4 LEDs onboard.
                        <table>
                            <thead>
                                <tr>
                                    <td>Colour</td>
                                    <td>#</td>
                                    <td>Pin</td>
                                    <td>Pin Alias</td>
                                    <td>PWM</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="text-red">red</span></td>
                                    <td>1</td>
                                    <td><code>A13</code></td>
                                    <td><code>LED_RED</code></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><span class="text-green">green</span></td>
                                    <td>2</td>
                                    <td><code>A14</code></td>
                                    <td><code>LED_GREEN</code></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><span class="text-yellow">yellow</span></td>
                                    <td>3</td>
                                    <td><code>A15</code></td>
                                    <td><code>LED_YELLOW</code></td>
                                    <td>Yes</td>
                                </tr>
                                <tr>
                                    <td><span class="text-blue">blue</span></td>
                                    <td>4</td>
                                    <td><code>B4</code></td>
                                    <td><code>LED_BLUE</code></td>
                                    <td>Yes</td>
                                </tr>
                            </tbody>
                        </table>
                    </section>

                    <section>
                        <h3><code>pyb.LED()</code></h3>
                        <pre><code class="hljs" data-trim contenteditable>
                            import pyb

                            red_led = pyb.LED(1)
                            yellow_led = pyb.LED(3)

                            # Basic controlls
                            red_led.on()
                            red_led.off()
                            red_led.toggle()

                            # Yellow and Blue have intensity control
                            yellow_led.intensity(0xff)  # same as on()
                            yellow_led.intensity(0x00)  # same as off()
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/outputs/pyb-led" class="prj-link">examples/outputs/pyb-led</a>
                    </section>

                    <section>
                        <h2>Digital Outputs</h2>
                        Let's control the <span class="text-red">red</span>
                        LED directly.
                        <pre><code class="hljs" data-trim contenteditable>
                            import machine

                            # Both yield the same pin instance
                            pin = machine.Pin('A13', machine.Pin.OUT)
                            pin = machine.Pin('LED_RED', machine.Pin.OUT)
                            pin.names()  # ['A13', 'LED_RED']  shows alternatives

                            # Changing pin's state
                            pin.high()  # or: pin.on()
                            pin.low()  # or: pin.off()
                            print(pin.value())  # prints 0
                            pin.value(1 - pin.value())  # toggles pin
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/outputs/digital" class="prj-link">examples/outputs/digital</a>
                    </section>

                    <section>
                        <h2>PWM Output</h2>
                        Let's control the <span class="text-blue">blue</span>
                        LED's intensity directly.

                        <pre><code class="hljs" data-trim contenteditable>
                            import machine
                            import pyb

                            pin = machine.Pin('LED_BLUE')
                            timer = pyb.Timer(3, freq=1000)
                            channel = tim.channel(1, pyb.Timer.PWM, pin=pin)

                            # Change blue LED's intensity manually
                            channel.pulse_width_percent(5)
                            channel.pulse_width_percent(50)
                            channel.pulse_width_percent(100)
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/outputs/pwm" class="prj-link">examples/outputs/pwm</a>
                    </section>

                    <section>
                        <h2>Analog Output</h2>
                        TODO
                    </section>

                </section>

                <!-- =================== INPUTS =================== -->
                <section id="inputs">
                    <section data-background="#28306a">
                        <h1>Inputs</h1>
                    </section>

                    <section>
                        <h3><code>pyb.Switch()</code></h3>
                        The pyboard has a switch marked <code>USR</code> on board.
                        <div class="columns">
                            <div class="col">
                                <img class="plain" src="images/circuits/switch.png" />
                            </div>
                            <div class="col">
                                <br/>
                                <pre><code class="hljs" data-trim contenteditable>
                                    import pyb

                                    switch = pyb.Switch()

                                    switch.value()
                                    # True when pressed
                                    # False when not pressed
                                </code></pre>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Digital Inputs</h2>
                        Check the same switch without using <code>pyb</code>
                        <pre><code class="hljs" data-trim contenteditable>
                            import machine

                            # Pin connected to pyboard's Switch
                            pin = machine.Pin('SW')
                            pin.names()  # ['B3', 'X17', 'SW']  alternatives

                            # The switch connects the B3 pin to GND when pressed
                            pin.value()  # 0 when pressed
                                         # 1 when not pressed
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/inputs/digital" class="prj-link">examples/inputs/digital</a>
                    </section>

                    <section>
                        <h2>Input Pull Up/Down</h2>
                        Inputs can be pulled up, down, or left to float.
                        <pre><code class="hljs" data-trim contenteditable>
                            import machine

                            pin = machine.Pin('SW', machine.Pin.IN, machine.Pin.PULL_UP)
                            pin = machine.Pin('SW', machine.Pin.IN, machine.Pin.PULL_DOWN)
                            pin = machine.Pin('SW', machine.Pin.IN, machine.Pin.PULL_NONE)

                            # These 2 initialize the pin in the same way
                            pin = machine.Pin('SW')  # defaults for SW are...
                            pin = machine.Pin('SW', machine.Pin.IN, machine.Pin.PULL_UP)
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/inputs/pull-up-down" class="prj-link">examples/inputs/pull-up-down</a>
                    </section>

                    <section>
                        <h2>Analog Inputs</h2>
                        <div class="columns">
                            <div class="col">
                                <img class="plain" src="images/circuits/adc.png" />
                            </div>
                            <div class="col">
                                <pre><code class="hljs" data-trim contenteditable>
                                    import machine
                                    import time
                                    import pyb

                                    pin = machine.Pin('X19')
                                    adc = pyb.ADC(pin)
                                    adc.read()  # reads value, 0-4095

                                    while True:
                                        time.sleep(0.1)
                                        value_ratio = adc.read() / 4095
                                        print('#' * int(40 * value_ratio))
                                </code></pre>
                            </div>
                        </div>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/inputs/analog" class="prj-link">examples/inputs/analog</a>
                    </section>

                </section>

                <!-- =================== COMMUNICATION =================== -->
                <section id="comms">
                    <section data-background="#28306a">
                        <h1>Comms</h1>
                        Communication<br/>protocols
                    </section>

                    <section>
                        <h2>UART</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            from pyb import UART

                            uart = UART(1)
                            uart.init(baudrate=9600)

                            uart.write(b'abc')   # send 3 bytes
                            data = uart.read(3)  # receive 3 bytes

                            uart.deinit()
                        </code></pre>
                    </section>

                    <section>
                        <h2>Virtual COM Port</h2>
                        <ul>
                            <li>UART over USB</li>
                            <li>No wiring necessary</li>
                            <li>baudrate can be set much higher<br/>than standard UART</li>
                        </ul>
                        <pre><code class="hljs" data-trim contenteditable>
                            from pyb import USB_VCP
                            vcp = USB_VCP()

                            vcp.write(b'abc')   # write 3 bytes
                            data = vcp.recv(3)  # receive 3 bytes
                        </code></pre>
                        <aside data-markdown class="notes">
                            ### Setting baudrate?
                            Baurdrate is set on the PC side
                        </aside>
                    </section>

                    <section>
                        <h2>I²C</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            from pyb import I2C

                            i2c = I2C(1)                         # create on bus 1
                            i2c = I2C(1, I2C.MASTER)             # create as a master
                            i2c.init(I2C.MASTER, baudrate=20000) # init as a master
                            i2c.init(I2C.SLAVE, addr=0x42)       # init as a slave

                            i2c.send(b'abc')     # send 3 bytes
                            i2c.send(0x42)       # send a single byte
                            data = i2c.recv(3)   # receive 3 bytes

                            i2c.deinit()  # turn off the peripheral
                        </code></pre>
                    </section>

                    <section>
                        <h3>Controller Area Network (CAN)</h3>
                        <ul>
                            <li>Used in all modern cars</li>
                            <li>Excellent immunity to noise</li>
                            <li>Large distances: 40m, even up to 1km</li>
                            <li>pyboard has 2 CAN controllers</li>
                            <li>Requires a tranceiver (probably: <a href="https://www.microchip.com/wwwproducts/en/MCP2562"><code>MCP2562</code></a>)</li>
                        </ul>
                        <aside data-markdown class="notes">
                            ### Transmission Distances

                            Distance depends on the baud rate:
                            - 1Mb: 40m
                            - 500Kb: 100m
                            - 100Kb: 500m
                            - 50Kb: 1km
                        </aside>
                    </section>
                    <section>
                        <h2>CAN: Wiring Diagram</h2>
                        <img class="plain" src="images/circuits/can1.png" />
                    </section>
                    <section>
                        <h2>CAN: Bit timing</h2>
                        <p>
                            1-bit
                            <div class="timing-diagram"><script type="WaveDrom">
                                {
                                    signal: [
                                        {name: '', wave: '01....0', node: '.ab.c.d.'},
                                        //{name: 'timing', wave: '023.4.0', data: ['1', 'bs1', 'bs2']},
                                    ],
                                    config: {hscale: 1},
                                    edge: [
                                        'a<->b 1',
                                        'b<->c bs1',
                                        'c<->d bs2',
                                    ],
                                }
                            </script></div>
                        </p>
                        <p>$prescaler = \frac{pclk1}{baud \times (1+bs1+bs2)}$</p>
                        <pre><code class="hljs" data-trim contenteditable>
                            import pyb

                            baud = 250000  # baudrate to 25k
                            pclk1 = pyb.freq()[2]  # = 42000000
                            (bs1, bs2) = (5, 8)  # arbitrarily chosen
                            prescaler = int(pclk1 / (baud * (1 + bs1 + bs2)))
                        </code></pre>
                        <p>
                            More on <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.CAN.html#pyb.CAN.init">bit timing</a>
                            and <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.html#pyb.freq">frequencies</a>
                        </p>
                        <aside data-markdown class="notes">
                            The pyboard's inbuilt CAN controller splits bits into
                            into time _quanta_ such that:

                            ```
                            1 / baud = quantum * (1 + bs1 + bs2)
                            quantum = prescaler / pclk1
                            ```

                            **IMPORTANT**

                            `prescaler` must equate to an integer to match the
                            configured `baud`; `int()` rounding down will
                            change effective baudrate.

                            The shown `bs1` and `bs2` values will work for
                            the most common baudrates: 125k, 250k, 500k, 1M
                        </aside>
                    </section>
                    <section>
                        <h2>CAN: Transmit</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            import pyb

                            # Initialize CAN controller
                            can1 = pyb.CAN(
                                1, pyb.CAN.NORMAL, extframe=False,
                                # timing values from previous slide
                                prescaler=prescaler, bs1=bs1, bs2=bs2,
                            )

                            # Transmit
                            can1.send(b'abc', 0x100)
                        </code></pre>
                    </section>
                    <section>
                        <h2>CAN: Receive</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            # Set explicit ID filter for IDs 0x100 - 0x103
                            can1.setfilter(
                                0, pyb.CAN.LIST16, 0, (0x100, 0x101 0x102, 0x103)
                            )

                            msg = can1.recv(0)
                            (msg_id, rtr, filter_index, data) = msg
                        </code></pre>
                        <p>
                            More on <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.CAN.html#pyb.CAN.setfilter">filtering</a>
                            and <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.CAN.html#pyb.CAN.rxcallback">callbacks</a>
                        </p>
                    </section>
                </section>

                <!-- =================== INTERRUPTS =================== -->
                <section id="interrupts">
                    <section data-background="#28306a">
                        <h1>Interrupts</h1>
                    </section>

                    <section>
                        <h2>External Interrupt</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            import pyb
                            import machine

                            def callback(i):
                                print("intr")

                            pin = machine.Pin(
                                'SW', machine.Pin.IN, machine.Pin.PULL_UP
                            )
                            ext = pyb.ExtInt(
                                pin,
                                pyb.ExtInt.IRQ_FALLING,
                                machine.Pin.PULL_UP,
                                callback
                            )
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/interrupts/ext" class="prj-link">examples/interrupts/ext</a>
                    </section>

                    <section>
                        <h2>Timer Interrupt</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            import machine
                            import pyb

                            led = machine.Pin('LED_RED')
                            def toggle_led_cb(tim):
                                led.value(1 - led.value())

                            timer = pyb.Timer(1, freq=1000)
                            timer.counter() # get counter value
                            timer.freq(2) # 2 Hz
                            timer.callback(toggle_led_cb)
                        </code></pre>
                        <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/interrupts/timer" class="prj-link">examples/interrupts/timer</a>
                    </section>

                    <section>
                        <h2>Memory Limitation</h2>
                        <p>
                            Interrupt code is run while the heap is locked;<br/>
                            no memory can be allocated, or de-allocated.
                        </p>
                        <ul>
                            <li><span class="fragment strike"><code>list.append</code> or <code>set.add</code></span></li>
                            <li><span class="fragment strike"><code>list.pop</code> or <code>set.remove</code></span></li>
                            <li><span class="fragment strike">function <code>return</code></span></li>
                            <li><span class="fragment strike">add a key to a <code>dict</code></span></li>
                            <li>and more</li>
                        </ul>
                    </section>

                    <section>
                        <h2>Scheduling</h2>
                        <p>
                            To work around interrupt limits.
                        </p>
                        <pre><code class="hljs" data-trim contenteditable>
                            import micropython, machine

                            switch = machine.Pin('SW')
                            timer = pyb.Timer(1, freq=2)

                            window = []
                            def populate_window(t):
                                global window
                                window = window[-9:] + [switch.value() == 0]

                            timer.callback(populate_window)  # BAD! raises MemoryError

                            def timer_callback(t):
                                micropython.schedule(populate_window, t)
                            timer.callback(timer_callback)
                        </code></pre>

                    </section>
                </section>

                <!-- =================== RUNNING SCRIPTS =================== -->
                <section id="your_script">
                    <section data-background="#28306a">
                        <h1>Your Script</h1>
                    </section>

                    <section>
                        <h2>Boot Order</h2>
                        <ol>
                            <li>SD Card - <code>/sd/main.py</code></li>
                            <li>Flash - <code>/flash/main.py</code></li>
                        </ol>
                        <p>
                            Both can be copied to via USB Mass Storage.<br/>
                            The <span class="text-red">red</span> LED will illuminate while
                            the device is busy.
                        </p>
                        <p>
                            Programs on SD cards alows a sort of nostalgic <i>cartridge</i> system.
                        </p>
                    </section>

                    <section>
                        <h2>Import Path</h2>
                        Defaults are...
                        <pre><code class="hljs" data-trim contenteditable>
                            >>> import sys
                            >>> sys.path
                            ['', '/sd', '/sd/lib', '/flash', '/flash/lib']
                        </code></pre>
                        an excellent guide is <a href="http://wiki.micropython.org/Importing-Modules">here</a>
                    </section>

                    <section>
                        <h2>Installing from PyPI</h2>
                        <ol>
                            <li>Download <code>.tar.gz</code> file</li>
                            <li>Extract to one of the <code>lib</code> folders</li>
                        </ol>

                        <aside data-markdown class="notes">
                            ## Examples to Install
                            - [micropython-curses.ascii](https://pypi.python.org/pypi/micropython-curses.ascii)
                            - [micropython-collections.defaultdict](https://pypi.python.org/pypi/micropython-collections.defaultdict)
                            - [micropython-fnmatch](https://pypi.python.org/pypi/micropython-fnmatch)
                            - [micropython-itertools](https://pypi.python.org/pypi/micropython-itertools)
                        </aside>
                    </section>

                    <section>
                        <h2>For Example...</h2>
                        Installing <code>itertools</code>.
                        <ul>
                            <li>Download <a href="https://pypi.python.org/pypi/micropython-itertools"><code>itertools</code> from PyPI</a></li>
                            <li>Extract to <code>lib</code> on the sd card</li>
                            <li>result should look like:<br/><a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/itertools-installed" class="prj-link">examples/itertools-installed</a></li>
                        </ul>
                    </section>

                </section>

                <!-- =================== DEBUGGING =================== -->
                <section id="debugging">
                    <section data-background="#28306a">
                        <h1>Debugging</h1>
                    </section>

                    <section>
                        <h2>+ Bug</h2>
                        Let's run a <a href="https://github.com/fragmuffin/howto-micropython/tree/master/examples/debug" class="prj-link">main.py</a> with a bug.
                        <pre><code class="hljs" data-trim contenteditable>
                            import pyb

                            led = pyb.LED(1)  # Red LED
                            sw = pyb.Switch()

                            while True:
                                time.sleep(0.05)
                                if sw.value():
                                    led.on()
                                else:
                                    led.off()
                        </code></pre>
                        <p>
                            <span class="fragment">You want a hint?</span>
                            <span class="fragment">I don't have time.</span>
                        </p>
                    </section>

                    <section>
                        <h2>Use a REPL</h2>
                        Read output from <code>MicroPython</code> interpreter.
                        <ol>
                            <li><a href="#/connect_to_repl">connect the board to a <code>REPL</code></a></li>
                            <li><i>soft</i> reset the board with <code>Ctrl+D</code></li>
                            <li>read the output</li>
                        </ol>
                    </section>

                    <section>
                        <h2>The Result</h2>
                        <code>Ctrl+D</code> is pressed...
                        <pre><code class="hljs" data-trim contenteditable>
                            >>>
                            PYB: sync filesystems
                            PYB: soft reboot
                            Traceback (most recent call last):
                              File "main.py", line 7, in &lt;module>
                            NameError: name 'time' is not defined
                            MicroPython v1.9.2 on 2017-08-23; PYBv1.1 with STM32F405RG
                            Type "help()" for more information.
                            >>>
                        </code></pre>
                        We see it doesn't know what <code>time</code> is on line 7.
                    </section>

                    <section>
                        <h2>Debugging Interrupts</h2>
                        To enable standard exception reporting to a REPL
                        <pre><code class="hljs" data-trim contenteditable>
                            import micropython
                            micropython.alloc_emergency_exception_buf(100)
                        </code></pre>
                        see
                        <a href="http://docs.micropython.org/en/v1.9.2/pyboard/library/micropython.html#micropython.alloc_emergency_exception_buf">
                            <code>alloc_emergency_exception_buf</code>
                        </a>
                        documentation for details.

                    </section>

                    <section>
                        <h2>Debugging with <code>pdb?</code></h2>
                        <p>
                            Not yet, sadly.
                        </p>
                        <p>
                            Watch
                            <a href="https://github.com/micropython/micropython-lib/tree/master/pdb">this space</a>
                            , and
                            <a href="https://github.com/micropython/micropython/issues/3009">#3009</a>
                            .
                        </p>
                    </section>
                </section>

                <!-- =================== LCD INTERFACE =================== -->
                <section id="lcd_interface">
                    <section data-background="#28306a">
                        <h1>LCD Interface</h1>
                    </section>

                    <section>
                        <h2>LCD160CRv1.0</h2>
                        <div class="columns">
                            <div class="col">
                                <img class="plain" src="images/lcd/diag.png" />
                            </div>
                            <div class="col">
                                <br/>
                                <ul>
                                    <li>Resolution: 160 x 128</li>
                                    <li>Colour: 16-bit (565)</li>
                                    <li>Screen refresh: 30fps</li>
                                    <li>Resistive Touch</li>
                                    <li><a href="https://store.micropython.org/#/products/LCD160CRv1_0">store + references</a></li>
                                    <li><a href="https://youtu.be/OOz9U_YdstM">demo video</a></li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Wiring</h2>
                        pyboard Right &nbsp; &gt;&gt; &nbsp; LCD Left
                        <div class="columns">
                            <div class="col">
                                <img class="plain" src="images/pyboard/v1.0_top.png" />
                            </div>
                            <div class="col">
                                <img class="plain" src="images/lcd/top.png" />
                            </div>
                        </div>

                        <aside data-markdown class="notes">
                            **There are 4 wiring options**

                            - `X`
                            - `Y`
                            - `XY` - shown in this slide
                            - YX
                        </aside>
                    </section>

                    <section>
                        <h2>Run Test</h2>
                        The <code>lcd160cr</code> &amp; <code>lcd160cr_test</code>
                        modules are included with pyboard's MicroPython build.

                        <pre><code class="hljs" data-trim contenteditable>
                            import lcd160cr
                            import lcd160cr_test

                            # Create LCD object
                            lcd = lcd160cr.LCD160CR('XY')

                            # Run built-in test on lcd
                            lcd160cr_test.test_features(lcd)
                            lcd160cr_test.test_mandel(lcd)
                        </code></pre>
                    </section>

                    <section>
                        <h2>Tests results</h2>
                        <div class="columns">
                            <div class="col">
                                Features<br/>
                                <img class="plain" width="60%" src="images/lcd/test_features.png" style="image-rendering: pixelated;" />
                            </div>
                            <div class="col">
                                <a href="https://en.wikipedia.org/wiki/Mandelbrot_set">Mandel</a><br/>
                                <img class="plain" width="60%" src="images/lcd/test_mandel.png" style="image-rendering: pixelated;" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Lines</h2>
                        <div class="columns">
                            <div class="col">
                                Code:
                                <pre><code class="hljs" data-trim contenteditable>
                                    import lcd160cr
                                    lcd = lcd160cr.LCD160CR('XY')

                                    # white on black
                                    lcd.set_pen(0xffff, 0)
                                    lcd.erase()  # clear screen

                                    # Draw a line
                                    lcd.line(0, 0, lcd.w, lcd.h)


                                </code></pre>
                            </div>
                            <div class="col">
                                Result:<br/>
                                <img class="plain" width="60%" src="images/lcd/draw_line.png" style="image-rendering: pixelated;" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Poly Lines</h2>
                        <div class="columns">
                            <div class="col">
                                Code:
                                <pre><code class="hljs" data-trim contenteditable>
                                    from math import sin, cos, pi
                                    x = int(lcd.w / 2)
                                    y = int(lcd.h / 2)

                                    points = []
                                    for i in range(6):
                                        a = i * (0.8 * pi)
                                        points += [
                                            x + int(60 * sin(a)),
                                            y + int(60 * cos(a))
                                        ]

                                    lcd.poly_line(
                                        bytearray(points)
                                    )
                                </code></pre>
                            </div>
                            <div class="col">
                                Result:<br/>
                                <img class="plain" width="60%" src="images/lcd/draw_polyline.png" style="image-rendering: pixelated;" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Boxes</h2>
                        <div class="columns">
                            <div class="col">
                                Code:
                                <pre><code class="hljs" data-trim contenteditable>
                                    # Set some colours
                                    BLUE = lcd.rgb(0, 0, 255)
                                    YELLOW = lcd.rgb(255, 255, 0)
                                    GREY_20 = lcd.rgb(51, 51, 51)

                                    lcd.set_pen(0, GREY_20)
                                    lcd.erase()

                                    lcd.set_pen(BLUE, YELLOW)
                                    lcd.rect(10, 10, 100, 70)
                                </code></pre>
                            </div>
                            <div class="col">
                                Result:<br/>
                                <img class="plain" width="60%" src="images/lcd/draw_rect.png" style="image-rendering: pixelated;" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Text</h2>
                        <div class="columns">
                            <div class="col">
                                Code:
                                <pre><code class="hljs" data-trim contenteditable>
                                    # Set some colours
                                    WHITE = lcd.rgb(255, 255, 255)
                                    GREEN = lcd.rgb(0, 255, 0)
                                    lcd.set_pen(WHITE, 0)
                                    lcd.set_text_color(GREEN, 0)

                                    for i in [1, 2, 3, 4]:
                                        # normal
                                        lcd.set_pos(10, i * 25)
                                        lcd.set_font(i, scale=0)
                                        lcd.write('Font%i' % i)
                                        # scaled up by 1
                                        lcd.set_pos(80, i * 25)
                                        lcd.set_font(i, scale=1)
                                        lcd.write('f%i' % i)
                                </code></pre>
                            </div>
                            <div class="col">
                                Result:<br/>
                                <img class="plain" width="60%" src="images/lcd/draw_text.png" style="image-rendering: pixelated;" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>JPG</h2>
                        <div class="columns">
                            <div class="col">
                                Code:
                                <p style="font-size:0.5em">
                                    Pre-process <code>jpg</code>:
                                </p>
                                <pre><code class="hljs" data-trim contenteditable>
                                    sudo apt install libjpeg-progs
                                    jpegtran orig.jpg > photo.jpg
                                </code></pre>
                                <p style="font-size:0.5em">
                                    pyboard code:
                                </p>
                                <pre><code class="hljs" data-trim contenteditable>
                                    fname = '/sd/images/photo.jpg'
                                    with open(fname, 'rb') as f:
                                        buf = bytearray(f.read())
                                    lcd.set_pos(0, 0)
                                    lcd.jpeg(buf)
                                </code></pre>
                            </div>
                            <div class="col">
                                Result<br/>
                                <img class="plain" width="60%" src="images/lcd/draw_jpg.png" style="image-rendering: pixelated;" />
                            </div>
                        </div>
                    </section>

                    <section>
                        <h2>Resistive Touch</h2>
                        <pre><code class="hljs" data-trim contenteditable>
                            (touching, x, y) = lcd.get_touch()

                            # touching: is True or False
                            # x: int coord of most recent touch
                            # y: int coord of most recent touch
                        </code></pre>
                    </section>

                    <section>
                        <h2>And More</h2>
                        <ul>
                            <li>Frame buffering</li>
                            <li>Window scrolling</li>
                            <li>Portrait / Landscape coordinates</li>
                            <li>Backlight brightness</li>
                            <li>Save settings to flash</li>
                        </ul>
                        <p>
                            Documentation <a href="https://docs.micropython.org/en/latest/pyboard/library/lcd160cr.html">here</a>.
                        </p>
                    </section>

                </section>

                <!-- =================== END =================== -->
                <section data-background="#000000">
                    <h2>Thank You</h2>
                    <div class="columns">
                        <div class="col">
                            <div class="qrcode" align="center"></div>
                            <div class="half-size">
                                <a class="qrcode-link"></a><br/>
                                also: <a href="https://github.com/fragmuffin/howto-micropython">the github repo'</a>
                            </div>
                        </div>
                        <div class="col">
                            <br/><br/>
                            <p>
                                By <a title="Visit me on Github" href="https://github.com/fragmuffin">Peter Boin</a>.
                            </p>
                            <p>
                                Made with <a title="reveal.js" href="https://github.com/hakimel/reveal.js">reveal.js</a>.
                            </p>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- QR Codes -->
        <script type="text/javascript">
            // Get presentation URL
            var qrcode_url = "https://fragmuffin.github.io/howto-micropython";
            if (!/^(localhost|127\.0\.1\.1|)$/.test(location.hostname)) {
                // host is not localhost, get dynamic URL
                //keep it simple
                //qrcode_url = window.location.href;
                console.log("host is not local, dynamic url: " + window.location.href);
            }

            // Generate QR Codes : class="qrcode"
            var qrcode_elements = document.getElementsByClassName('qrcode');
            for (var i=0; i<qrcode_elements.length; i++) {
                var qrcode_el = qrcode_elements[i];

                var qrcode = new QRCode(qrcode_el, {
                    text: qrcode_url,
                    width: 350,
                    height: 350
                });

                // Alter generated image
                var img_el = qrcode._el.childNodes[1];
                img_el.classList.add("plain"); // remove border
            }

            // Add text to links : class="qrcode-link"
            var qrcode_link_elements = document.getElementsByClassName('qrcode-link');
            for (var i=0; i<qrcode_link_elements.length; i++) {
                var link_el = qrcode_link_elements[i];
                link_el.textContent = qrcode_url;
                link_el.href = qrcode_url;
            }
        </script>

        <script>
            WaveDrom.ProcessAll();
        </script>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
            // More info about config & dependencies:
            // - https://github.com/hakimel/reveal.js#configuration
            // - https://github.com/hakimel/reveal.js#dependencies
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,
                transition: 'slide', // none/fade/slide/convex/concave/zoom

                dependencies: [
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/notes/notes.js', async: true },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/math/math.js', async: true }
                ]
            });
        </script>

    </body>
</html>
